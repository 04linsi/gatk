version: 2.1

jobs:
  downloadLFSFiles:
    docker:
      - image: circleci/openjdk:8u181-jdk
    steps:
      - run:
          name: install git-lfs
          command: |
            curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash
            sudo apt-get install -y git-lfs
            git lfs --version
            git --version
            git config --global --add lfs.concurrenttransfers 50
      - checkout
      - persist_to_workspace:
          root: .
          paths:
            - src/test/resources/large
            - src/main/resources/large
  buildDocker:
    environment:
      GIT_LFS_SKIP_SMUDGE=1
    docker:
      - image: circleci/openjdk:8u181-jdk
    steps:
      - run:
          name: "Install git-lfs"
          command: |
            curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash
            sudo apt-get install -y git-lfs
            git lfs --version
            git --version
            git config --global --add lfs.concurrenttransfers 50
      - checkout
      - run: git lfs pull -I src/main/resources/large
      - run: ./gradlew clean collectBundleIntoDir shadowTestClassJar shadowTestJar
      - run:
          name: "Build Docker"
          command: |
              ZIPPATHGATK=$( find ./build -name "*bundle-files-collected" )
              mv ${ZIPPATHGATK} ./unzippedJar
              ZIPPATHPYTHON=$( find ./unzippedJar -name "gatkPython*.zip" )
              unzip -o -j ${ZIPPATHPYTHON} -d ./unzippedJar/scripts
              mkdir ./testJars
              mv $( find ./build/libs/ -name "gatk*test.jar" ) ./testJars
              mv $( find ./build/libs/ -name "gatk*testDependencies.jar" ) ./testJars
              echo "Building image to tag gatk-test-docker"
              docker build -t gatk-test-docker --build-arg ZIPPATH=./unzippedJar .
      - setup_remote_docker
      - run: docker save -o docker.tar gatk-test-docker
      - run: ls -lh docker.tar
      - persist_to_workspace:
          root: "."
          paths:
            - docker.tar
            - testJars

  runStandardTests:
    description: "Run one of our standard test groups"
    parameters:
      testtype:
         description: "value for TEST_TYPE"
         type: string
    docker:
      - image: broadinstitute/gatk:gatkbase-2.0.3
        environment:
          TEST_VERBOSITY=minimal
    steps:
      - run:
          name: run tests
          command: ./gradlew test
workflows:
  build:
    jobs:
      - buildDocker
      - downloadLFSFiles